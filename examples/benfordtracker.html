<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>tracking.js - color with video</title>

  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <!--<link rel="stylesheet" href="assets/demo.css">
  <script src="../node_modules/dat.gui/build/dat.gui.min.js"></script>
  <script src="assets/stats.min.js"></script>
  <script src="assets/color_camera_gui.js"></script>-->
  <script src="../build/tracking-min.js"></script>


  <style>
  .demo-container {
    background-color: black;
  }

  video, canvas {
    position: absolute;
  }
  </style>
</style>
</head>
<body>
  <h2>Teste Algorítimo Benford</h2>
  <table width="1200" vertical-align="top">
    <tbody>
      <tr>
        <td>
          <div class="inputoutput">
            <div class="caption">
              <button type="button" id="buttonCameraVideo">Usar câmera</button>
              ou Selecione um vídeo. <input type="file" id="fileInputVideo" name="file" />
              <!--
              <input id="slider" oninput="mudarVolume(0)" type="range" min="0" max="10" value="0" step="0.01">
              Volume: <span id="volume"></span>
            -->
          </div>
        </div>
      </td>
    </tr>
    <tr>
      <td>
        <div class="demo-frame">
          <div class="demo-container">
            <canvas id="canvas" width="800" height="500"></canvas>
            <video id="myVideo" width="800" height="500" preload autoplay loop muted></video>
          </div>
        </div>
      </td>
      <td>
        <div id="triplo" style="width: 300px; height: 500px;"></div>
        <!--<div id="espacial" style="width: 300px; height: 500px;"></div>-->
        <!--<div id="temporal" style="width: 300px; height: 500px;"></div>-->
      </td>
    </tr>
  </tbody>
</table>

<script>
// Implementação de Benford Tracker -----------------------------------------------------------
var maxFila = 9;
var  filaValida = false;
var  fila = [maxFila];
var valoresBF = [maxFila];
var indexFila = 0;
var triploBF = [maxFila-1];
var espacialBF = [maxFila];
var temporalBF = [maxFila];
var acumuladoTriplo = 0;
var acumuladoEspacial = 0;
var acumuladoTemporal;
var ocorrenciaNumerosTriploPorFrame = [maxFila-1];
var ocorrenciaNumerosEspacialPorFrame = [maxFila];
var ocorrenciaNumerosTemporalPorFrame = [maxFila-1];

ocorrenciaNumerosTemporalPorFrame[0] = 10;
ocorrenciaNumerosTemporalPorFrame[1] = 5;

function BenfordTracker() {

  this.track = function(pixels, width, height) {
    // Your code here
    let gray = tracking.Image.grayscale(pixels, width, height, false);

    processarFrameTriplo(gray, width, height);
    processarFrameEspacial(gray, width, height);

    //let results = matrizOcorrencias();
    let results = calcularOcorrencia();
    this.emit('track', {
      data: results
    });
  }



  valoresBF[0] = Math.log10(1.0+1.0/1.0);
  valoresBF[1] = Math.log10(1.0+1.0/2.0);
  valoresBF[2] = Math.log10(1.0+1.0/3.0);
  valoresBF[3] = Math.log10(1.0+1.0/4.0);
  valoresBF[4] = Math.log10(1.0+1.0/5.0);
  valoresBF[5] = Math.log10(1.0+1.0/6.0);
  valoresBF[6] = Math.log10(1.0+1.0/7.0);
  valoresBF[7] = Math.log10(1.0+1.0/8.0);
  valoresBF[8] = Math.log10(1.0+1.0/9.0);

  let frameAnterior = null;
  let quadradoEspacialX = null;
  let quadradoEspacialY = null;
  let filaNorma = [maxFila];
  let contaOcorrenciaNumeroPrimeiroDigito = 0 ;
  var normaEspacial = [maxFila];
  var normaTemporal = [maxFila];
  var normaTripla = [maxFila];

  zerarFilaOcorrencia();
  var  filaCheia = false;


  function processarFrameEspacial(img, width, height) {
    if(img){
      for (var index = 1; index < height*width-width; ++index) {
        let gradienteEspacialX = img[index+1] - img[index];
        let gradienteEspacialY = img[index+width] - img[index];

        quadradoEspacialX = Math.pow(gradienteEspacialX, 2);
        quadradoEspacialY = Math.pow(gradienteEspacialY, 2);
        normaEspacial[indexFila] = Math.sqrt(quadradoEspacialX  + quadradoEspacialY);

        if (normaEspacial[indexFila] > 0.001) {//se a norma espacial for significativa
          if(normaEspacial[indexFila] > 100) {
            contaOcorrenciaNumeroPrimeiroDigito = (normaEspacial[indexFila]-normaEspacial[indexFila]%100)/100;
          } else if (normaEspacial[indexFila] > 10) {
            contaOcorrenciaNumeroPrimeiroDigito = (normaEspacial[indexFila]-normaEspacial[indexFila]%10)/10;
          } else {
            contaOcorrenciaNumeroPrimeiroDigito = normaEspacial[indexFila]-normaEspacial[indexFila]%1;
          }
          ocorrenciaNumerosEspacialPorFrame[indexFila][contaOcorrenciaNumeroPrimeiroDigito-1]++;
        }
      }

      frameAnterior = img;
      img = null;
    }
  };

  function processarFrameTriplo( img, width, height ) {
    if(frameAnterior){
      for (var index = 1; index < height*width-width; ++index) {
        normaTemporal[indexFila] = img[index] - frameAnterior[index];
        let quadradoTemporal = Math.pow(normaTemporal[indexFila], 2);
        normaTripla[indexFila] = Math.sqrt( quadradoEspacialX + quadradoEspacialY + quadradoTemporal);

        if (normaTemporal[indexFila] > 0.001) {//se a norma espacial for significativa
          if(normaTemporal[indexFila] > 100) {
            contaOcorrenciaNumeroPrimeiroDigito = (
              [indexFila]-normaTemporal[indexFila]%100)/100;
          } else if (normaTemporal[indexFila] > 10) {
            contaOcorrenciaNumeroPrimeiroDigito = (normaTemporal[indexFila]-normaTemporal[indexFila]%10)/10;
          } else {
            contaOcorrenciaNumeroPrimeiroDigito = normaTemporal[indexFila]-normaTemporal[indexFila]%1;
          }
          ocorrenciaNumerosTemporalPorFrame[indexFila][contaOcorrenciaNumeroPrimeiroDigito-1]++;
        }

        if (normaTripla[indexFila] > 0.001) {//se a norma espacial for significativa
          if(normaTripla[indexFila] > 100) {
            contaOcorrenciaNumeroPrimeiroDigito = (normaTripla[indexFila]-normaTripla[indexFila]%100)/100;
          } else if (normaTripla[indexFila] > 10) {
            contaOcorrenciaNumeroPrimeiroDigito = (normaTripla[indexFila]-normaTripla[indexFila]%10)/10;
          } else {
            contaOcorrenciaNumeroPrimeiroDigito = normaTripla[indexFila]-normaTripla[indexFila]%1;
          }
          ocorrenciaNumerosTriploPorFrame[indexFila][contaOcorrenciaNumeroPrimeiroDigito-1]++;
        }
      }

      indexFila += 1
      if(!filaCheia && indexFila >= maxFila){
        filaCheia = true;
      }
      indexFila = indexFila%maxFila;
    }
  };

  function zerarFilaOcorrencia(){
    for(let x = 0; x < maxFila; ++x) {
      ocorrenciaNumerosEspacialPorFrame[x] = [9];
      ocorrenciaNumerosTemporalPorFrame[x] = [9];
      ocorrenciaNumerosTriploPorFrame[x] = [9];
      temporalBF[x] = 0;
      espacialBF[x] = 0;
      triploBF[x] = 0;
      for(let y = 0; y < maxFila; ++y) {
        ocorrenciaNumerosEspacialPorFrame[x][y] = 0;
        ocorrenciaNumerosTemporalPorFrame[x][y] = 0;
        ocorrenciaNumerosTriploPorFrame[x][y] = 0;
      }
    }
  };

  function matrizOcorrencias(){
    if(filaCheia){
      let mapaOcorrencia = new Map();
      mapaOcorrencia.set("espacial", ocorrenciaNumerosEspacialPorFrame);
      mapaOcorrencia.set("temporal", ocorrenciaNumerosTemporalPorFrame);
      mapaOcorrencia.set("triplo", ocorrenciaNumerosTriploPorFrame);
      return mapaOcorrencia;
    }
  };

  function calcularOcorrencia(){
    if(filaCheia){
      let acumuladoTriplo = 0;
      let acumuladoEspacial = 0;
      let acumuladoTemporal = 0;
      let diferencaTripla = 0.0;
      let diferencaEspacial = 0.0;
      let diferencaTemporal = 0.0;
      for(let x = 0; x < maxFila; ++x) {
        for(let y = 0; y < maxFila; ++y) {
          if(ocorrenciaNumerosEspacialPorFrame[x][y]){
            acumuladoEspacial += ocorrenciaNumerosEspacialPorFrame[x][y];
            espacialBF[y] +=  ocorrenciaNumerosEspacialPorFrame[x][y];
          }
          if(ocorrenciaNumerosTemporalPorFrame[x][y]){
            acumuladoTemporal += ocorrenciaNumerosTemporalPorFrame[x][y];
            temporalBF[y] += ocorrenciaNumerosTemporalPorFrame[x][y]
          }
          if(ocorrenciaNumerosTriploPorFrame[x][y]){
            acumuladoTriplo += ocorrenciaNumerosTriploPorFrame[x][y];
            triploBF[y] += ocorrenciaNumerosTriploPorFrame[x][y]
          }
        }
      }

      for(let nivel = 0; nivel < maxFila; nivel++) {
        for(let indexFilaAtual = 0; indexFilaAtual < maxFila; indexFilaAtual++) {
          if (ocorrenciaNumerosTriploPorFrame[indexFilaAtual][nivel]){
            if (((ocorrenciaNumerosTriploPorFrame[indexFilaAtual][nivel]/acumuladoTriplo)) > 0) {
              diferencaTripla += (ocorrenciaNumerosTriploPorFrame[indexFilaAtual][nivel]/acumuladoTriplo);
            } else {
              diferencaTripla -= (ocorrenciaNumerosTriploPorFrame[indexFilaAtual][nivel]/acumuladoTriplo);
            }
          }
        }
      }

      diferencaTripla /= 2;
      for(let nivel = 0; nivel < maxFila; nivel++) {
        for(let indexFilaAtual = 0; indexFilaAtual < maxFila; indexFilaAtual++) {
          if (ocorrenciaNumerosEspacialPorFrame[indexFilaAtual][nivel]){
            if (((ocorrenciaNumerosEspacialPorFrame[indexFilaAtual][nivel]/acumuladoEspacial)) > 0) {
              diferencaEspacial += (ocorrenciaNumerosEspacialPorFrame[indexFilaAtual][nivel]/acumuladoEspacial);
            } else {
              diferencaEspacial -= (ocorrenciaNumerosEspacialPorFrame[indexFilaAtual][nivel]/acumuladoEspacial);
            }
          }
        }
      }

      diferencaTemporal /= 2;
      for(let nivel = 0; nivel < maxFila; nivel++) {
        for(let indexFilaAtual = 0; indexFilaAtual < maxFila; indexFilaAtual++) {
          if (ocorrenciaNumerosTemporalPorFrame[indexFilaAtual][nivel]){
            if (((ocorrenciaNumerosTemporalPorFrame[indexFilaAtual][nivel]/acumuladoTemporal)) > 0) {
              diferencaTemporal += (ocorrenciaNumerosTemporalPorFrame[indexFilaAtual][nivel]/acumuladoTemporal);
            } else {
              diferencaTemporal -= (ocorrenciaNumerosTemporalPorFrame[indexFilaAtual][nivel]/acumuladoTemporal);
            }
          }
        }
      }

      let mapaOcorrencia = new Map();
      mapaOcorrencia.set("espacial", diferencaEspacial.toFixed(2));
      mapaOcorrencia.set("temporal", diferencaTemporal.toFixed(2));
      mapaOcorrencia.set("triplo", diferencaTripla.toFixed(2));
      return mapaOcorrencia;
    }
  }

}


// Load the Visualization API and the corechart package.
google.charts.load('current', {'packages':['bar']});
// Set a callback to run when the Google Visualization API is loaded.
google.charts.setOnLoadCallback(drawStuff);
// Callback that creates and populates a data table,
// instantiates the pie chart, passes in the data and
// draws it.


function drawStuff() {
  // Create the data table.
  var data = new google.visualization.arrayToDataTable([
    ['Número', 'Ocurrência'],
    ["1", temporalBF[0]],
    ["2", temporalBF[1]],
    ["3", temporalBF[2]],
    ["4", temporalBF[3]],
    ["5", temporalBF[4]],
    ["6", temporalBF[5]],
    ["7", temporalBF[6]],
    ['8', temporalBF[7]],
    ['9', temporalBF[8]]
  ]);

  // Set chart options
  var options = {
    title: 'Gradiente Triplo de Benford',
    width: 300,
    legend: { position: 'none' },
    chart: { title: 'Gradiente Triplo de Benford',
    subtitle: 'Ocorrencia primeiro dígito por número' },
    bars: 'vertical', // Required for Material Bar Charts.
    axes: {
      x: {
        0: { side: 'down', label: 'Números'} // Top x-axis.
      },
      y: {
        0: { side: 'left', label: 'Porcentágem'} // Top x-axis.
      }
    },
    bar: { groupWidth: "90%" }
  };
  // Instantiate and draw our chart, passing in some options.
  var chart = new google.charts.Bar(document.getElementById('triplo'));
  chart.draw(data, options);
};
window.setInterval('drawStuff()', 1000);
//Implementação da Herança de BenfordTracker em relação a Traker da API tracking.js
tracking.inherits(BenfordTracker, tracking.Tracker);;
BenfordTracker.prototype.constructor = BenfordTracker;

var canvas = document.getElementById('canvas');
var context = canvas.getContext('2d');

var myTracker = new BenfordTracker();

//Tratamento de eventos recebidos já processados
myTracker.on('track', function(event){
  context.clearRect(0, 0, canvas.width, canvas.height);
  context.strokeStyle = "#000";
  context.font = '10px Helvetica';
  context.fillStyle = "#000"

  if(event.data){

    mudarVolume(event.data.get("espacial"));
    context.fillText("Espacial: " + event.data.get("espacial"), 0 + 5, 10 + 22);
    context.fillText("Temporal: " + event.data.get("temporal"), 0 + 5, 20 + 22);
    context.fillText("Triplo: " + event.data.get("triplo"), 0 + 5, 30 + 22);
  }
});

// Controes de Entrada --------------------------------------------------------
//Exibir e processar o video da câmera  function capturaVideoWebCam
let inputElementVideo1 = document.getElementById('buttonCameraVideo');
inputElementVideo1.addEventListener('click', (e) => {
  tracking.track('#myVideo', myTracker, { camera: true });
  playSound();
}, false);
//Exibir e processar video do armazenamento local
let inputElementVideo2 = document.getElementById('fileInputVideo');
inputElementVideo2.addEventListener('change', (e) => {
  let videoTag = document.getElementById('myVideo');
  videoTag.src=URL.createObjectURL(e.target.files[0]);
  videoTag.play();
  tracking.track('#myVideo', myTracker);
  playSound();
}, false);
// -------------------------------------------------------- Controes de Entrada

// Controles de Som -----------------------------------------------------------
var audioContext = new (window.AudioContext || window.webkitAudioContext)();
var isPlaing = false;
var oscilador = audioContext.createOscillator();
var ganho = audioContext.createGain();
ganho.gain = 0;
//var slider = document.getElementById("slider");
//var output = document.getElementById("volume");
oscilador.connect(ganho);

oscilador.start();

function playSound() {
  if(isPlaing){
    //oscilador.connect(biguad);
    ganho.disconnect(audioContext.destination);
    isPlaing = false;
  } else {
    //oscilador.disconnect(biguad);
    isPlaing = true;
    ganho.connect(audioContext.destination);
  }
}

function mudarVolume(volume) {
  if(volume>10.0){
    ganho.gain.value = volume/10;
    //output.innerHTML = volume/10;
  }
  if(volume<1.0){
    ganho.gain.value = volume*10;
    //output.innerHTML = volume*10;
  }
}
// ----------------------------------------------------------- Controles de Som


//initGUIControllers(myTracker);

</script>
</body>
</html>
